#!/bin/bash

# Galaxy startup script
#
# ELIXIR-ITALY
# INDIGO-DataCloud
# IBIOM-CNR

# Contributors:
# author: Tangaro Marco
# email: ma.tangaro@ibiom.cnr.it

## Uncomment and edit this line to refer to galaxy's path:
GALAXY='{{ galaxy_install_path }}'
GALAXYCTL='/usr/local/bin'
timeout=600

#______________________________________
# Load Galaxy environment

echo "Loading Galaxy environment"
cd ${GALAXY}
. ${GALAXY}/.venv/bin/activate

#______________________________________
# Define start function
# (supervisord or systemd/upstart)
function start_galaxy {

  echo "Starting the Galaxy production environment"
{% if ansible_virtualization_role == "docker" or (ansible_virtualization_role != "docker" and init_type == "supervisord") %}
  supervisord -c {{ supervisord_conf_path }}/supervisord.conf
{% else %}
{% if ansible_os_family == "Debian" and ansible_distribution_version == "14.04" %}
  service galaxy start
{% else %}
  systemctl start galaxy.service
{% endif %}
{% endif %}

  # wait supervisord start
  sleep 10

  # Check if galaxy is started and wait for uwsgi workers accepting requests.
  echo "Galaxy is starting"
  python $GALAXYCTL/galaxyctl galaxy-startup -c $GALAXY/config/galaxy.ini -t 600
}

#______________________________________
# Start Galaxy production environment
start_galaxy
