---
# Update ucsc genome database

#______________________________________
# Default Update via updateucsc.sh script

- name: Create updateucsc script
  copy:
    src: '{{ galaxy_install_path}}/cron/updateucsc.sh.sample'
    dest: '{{ galaxy_install_path}}/cron/updateucsc.sh'
    mode: a+x

- name: Change PYTHONPATH directory
  lineinfile:
    dest: '{{ galaxy_install_path}}/cron/updateucsc.sh'
    regexp: '#GALAXY=/galaxy/path'
    line: 'GALAXY={{ galaxy_install_path }}'

- name: run updateucsc monthly cron job on the first sunday
  cron:
    name: updateucsc
    minute: 0
    hour: 0
    weekday: 7
    job: '[ $(date +\%d) -le 07 ] && {{ galaxy_install_path }}/updateucsc.sh'

#______________________________________
# Fast Update (only for testing)

- name: Download ucsc genome idexes
  get_url:
    url: 'http://cloud.recas.ba.infn.it:8080/v1/AUTH_3b4918e0a982493e8c3ebcc43586a2a8/INDIGO-REVIEW/ucsc.tar.gz'
    dest: /tmp/ucsc.tar.gz
    force: yes
    timeout: 100
  when: fast_update

- name: Copy ucsc genome indexes
  unarchive: src=/tmp/ucsc.tar.gz dest=/home/galaxy/galaxy/tool-data/shared/ remote_src=yes
  when: fast_update
